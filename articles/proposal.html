<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proposal: Joint profiling of native and R code • jointprof</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Proposal: Joint profiling of native and R code">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">jointprof</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/jointprof.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/internals.html">Collecting and merging dual call stacks</a>
    </li>
    <li>
      <a href="../articles/proposal.html">Proposal: Joint profiling of native and R code</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-prof/gprofiler">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Proposal: Joint profiling of native and R code</h1>
                        <h4 class="author">Kirill Müller</h4>
            
            <h4 class="date">2019-01-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/r-prof/gprofiler/blob/master/vignettes/proposal.Rmd"><code>vignettes/proposal.Rmd</code></a></small>
      <div class="hidden name"><code>proposal.Rmd</code></div>

    </div>

    
    
<div id="the-problem" class="section level1">
<h1 class="hasAnchor">
<a href="#the-problem" class="anchor"></a>The problem</h1>
<p>The <a href="http://www.moscowcoffeereview.com/programming/the-3-rules-of-optimization/">three rules of software optimization</a> are:</p>
<ol style="list-style-type: decimal">
<li>Don’t.</li>
<li>Don’t do it yet.</li>
<li>Profile before optimizing.</li>
</ol>
<p>This proposal discusses simplifying the application of these rules for R code that calls into native code.</p>
<div id="why-is-it-a-problem" class="section level2">
<h2 class="hasAnchor">
<a href="#why-is-it-a-problem" class="anchor"></a>Why is it a problem?</h2>
<p>R has excellent facilities for profiling R code: the main entry point is the <a href="https://www.rdocumentation.org/packages/utils/versions/3.3.2/topics/Rprof"><code><a href="https://www.rdocumentation.org/packages/utils/topics/Rprof">Rprof()</a></code></a> function that starts an execution mode where the R call stack is sampled periodically, optionally at source line level, and written to a file. Memory usage can also be collected. The results of a profiling run can be analyzed with <code><a href="https://www.rdocumentation.org/packages/utils/topics/summaryRprof">summaryRprof()</a></code>, or visualized using the <code>profvis</code>, <code>aprof</code>, or <code>GUIProfiler</code> packages.</p>
<p>With <code><a href="https://www.rdocumentation.org/packages/utils/topics/Rprof">Rprof()</a></code>, the execution time of native code is only available as a bulk, without detailed source information. Conversely, when using a native code profiler such as <a href="https://gperftools.github.io/gperftools/cpuprofile.html"><code>gperftools</code></a> or <a href="http://valgrind.org/docs/manual/cl-manual.html"><code>callgrind</code></a>, the resulting profile does not contain any link to the original R source code. The same applies to memory usage information.</p>
<p>This project aims at bridging this gap with a drop-in replacement to <code><a href="https://www.rdocumentation.org/packages/utils/topics/Rprof">Rprof()</a></code> that records call stacks and memory usage information at both R and native levels, and later commingles them to present a unified view to the user. This drop-in replacement can be designed with support for multiple processes or threads in mind, another shortcoming of the current implementation of R’s profiler.</p>
</div>
<div id="who-does-it-affect" class="section level2">
<h2 class="hasAnchor">
<a href="#who-does-it-affect" class="anchor"></a>Who does it affect?</h2>
<p>Calling native code from R is done mostly for one or both of the following reasons:</p>
<ol style="list-style-type: decimal">
<li>A particular algorithm or library is implemented in C/C++/Fortran/…, the R code is mostly a wrapper around the native code. Examples:
<ul>
<li>
<code>RCurl</code> and <code>curl</code> wrap libcurl</li>
<li>Database drivers such as <code>RSQLite</code> and <code>RMySQL</code> usually wrap native libraries</li>
<li>
<code>haven</code> wraps ReadStat, which reads foreign data formats</li>
<li>
<code>RcppCCTZ</code> wraps CCTZ, a modern library for handling time zones</li>
<li>
<code>RcppTOML</code> wraps cpptoml, a library to parse configuration files in the TOML language</li>
</ul>
</li>
<li>An implementation of a particular functionality in R is too slow for its application and is substituted by a faster native variant. Examples:
<ul>
<li>
<code>randomForest</code> has C and Fortran code at its core</li>
<li>Sparse matrix (and other) algorithms in <code>Matrix</code>
</li>
<li>Converting a matrix to a data frame in <code>tibble</code>
</li>
<li>Fast reading of CSV and text files in <code>readr</code> and <code>data.table</code>
</li>
<li>Fast computation of groupwise aggregates in <code>dplyr</code> and <code>data.table</code>
</li>
<li>Graph algorithms in <code>igraph</code>
</li>
</ul>
</li>
</ol>
<p>Calls to native code from R packages are widespread: More than 500 CRAN packages consist mostly of C code, according to a <a href="https://github.com/search?q=org%3Acran+language%3Ac&amp;ref=searchresults&amp;type=Repositories&amp;utf8=%E2%9C%93">GitHub search</a>. The <a href="https://cran.r-project.org/package=Rcpp"><code>Rcpp</code> package</a>, which makes it trivial to embed C++ code in a package, is currently used by over 900 CRAN packages. Furthermore, it is very easy to create a one-off C++ function for use in an analysis script with the help of <code><a href="https://www.rdocumentation.org/packages/Rcpp/topics/cppFunction">Rcpp::cppFunction()</a></code>.</p>
</div>
<div id="what-will-solving-the-problem-enable" class="section level2">
<h2 class="hasAnchor">
<a href="#what-will-solving-the-problem-enable" class="anchor"></a>What will solving the problem enable?</h2>
<p>Improved profiling facilities will greatly simplify the analysis and elimination of run time and memory bottlenecks in such code.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> Over time, faster and less memory-hungry implementations will save computational resources or allow tackling larger problems.</p>
</div>
</div>
<div id="the-plan" class="section level1">
<h1 class="hasAnchor">
<a href="#the-plan" class="anchor"></a>The plan</h1>
<p>A joint R/native profiler can be implemented based on the following outline:</p>
<ol style="list-style-type: decimal">
<li>Sample stack traces simultaneously at both R and the native levels.</li>
<li>Locate native calls (if available) in the R stack traces.</li>
<li>Replace these by the relevant parts of the native stack traces.</li>
</ol>
<p>The <code>jointprof</code> package, available on GitHub at <a href="https://github.com/r-prof/jointprof" class="uri">https://github.com/r-prof/jointprof</a>, is a working proof of concept (currently only 64-bit Ubuntu Linux) for the seemingly tricky first step.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> No change to base R is necessary to achieve this. As a result, a data frame of samples is returned where each row contains both R and native stack traces (separately in two columns).</p>
<p>The native stack traces are currently generated using the <code>gperftools</code> library because it was easiest to get started with. The ultimate choice of native profiler will depend on other factors, such as platform interoperability (in particular Windows compatibility) and ease of integration. Regardless of this choice, the joint R/native profiler will create an <code>.Rprof</code> file compatible with those created by <code><a href="https://www.rdocumentation.org/packages/utils/topics/Rprof">Rprof()</a></code>, so that existing tools in the R ecosystem can be used to further analyze and visualize profiling results. For interoperability, the <code>proftools</code> package already offers a way to convert an <code>.Rprof</code> file to the format created by <code>callgrind</code> and understood by a number of tools outside the R ecosystem.</p>
<p>The project includes the development of three R packages, see also the <code>jointprof</code> <a href="https://github.com/r-prof/jointprof/issues">issue tracker</a> on GitHub:</p>
<ol style="list-style-type: decimal">
<li>A profiler package with the <code><a href="https://www.rdocumentation.org/packages/utils/topics/Rprof">Rprof()</a></code> drop-in replacement, based on the technique demonstrated in <code>jointprof</code>.
<ul>
<li>Read the output of the native profiler (<code>*.prof</code> files for <code>gperftools</code>).</li>
<li>Merge R and native call stacks.</li>
<li>New feature: suspend and resume profiling.</li>
</ul>
</li>
<li>A wrapper package around the native profiling library to simplify installation on Windows (and perhaps other OS-es).</li>
<li>A helper I/O package for reading, manipulating, and writing R profiler data.</li>
</ol>
<p>Splitting the work in smaller packages helps code reuse and allows better testing of the individual components. In particular, the I/O package can then be used by other packages or code without having to include a potentially heavy dependency. The code and intermediate format currently used by the <code>profvis</code> package can be used as a starting point, its maintainer Winston Chang has indicated <a href="https://github.com/rstudio/profvis/issues/74#issuecomment-264495380">consent</a>.</p>
<p>Best practices, such as version control, continuous integration, and clean code, will be used throughout the project to ensure quality and maintainability.</p>
<div id="timeline" class="section level2">
<h2 class="hasAnchor">
<a href="#timeline" class="anchor"></a>Timeline</h2>
<p>The project’s timeline corresponds to a full-time workload and does not reflect actual completion times. I expect to complete the project in roughly four months after acceptance, and to present final results at useR!2017 in Brussels.</p>
<div id="week-1" class="section level3">
<h3 class="hasAnchor">
<a href="#week-1" class="anchor"></a>Week 1</h3>
<ul>
<li>Initial blog post.</li>
<li>Review of other profiling libraries.</li>
<li>Test platform interoperability.</li>
<li>Wrapper package for profiling library.</li>
</ul>
</div>
<div id="week-2" class="section level3">
<h3 class="hasAnchor">
<a href="#week-2" class="anchor"></a>Week 2</h3>
<ul>
<li>Read output of native profiler.</li>
</ul>
</div>
<div id="week-3" class="section level3">
<h3 class="hasAnchor">
<a href="#week-3" class="anchor"></a>Week 3</h3>
<ul>
<li>Read, manipulate, and write output of R profiler.</li>
<li>Merge R and native profiler data.</li>
</ul>
</div>
<div id="week-4" class="section level3">
<h3 class="hasAnchor">
<a href="#week-4" class="anchor"></a>Week 4</h3>
<ul>
<li>Roundtrips from R to native and back to R.</li>
<li>Further testing on Linux, OS X, and Windows.</li>
<li>Multiple processes and threads.</li>
<li>Ad-hoc functions.</li>
<li>Memory profiling.</li>
<li>On-the-fly reading of profiler data for realtime preview.</li>
</ul>
</div>
<div id="week-5" class="section level3">
<h3 class="hasAnchor">
<a href="#week-5" class="anchor"></a>Week 5</h3>
<ul>
<li>Finalization, documentation.</li>
<li>Final blog post.</li>
<li>useR!2017 presentation.</li>
</ul>
</div>
</div>
<div id="potential-pitfalls" class="section level2">
<h2 class="hasAnchor">
<a href="#potential-pitfalls" class="anchor"></a>Potential pitfalls</h2>
<p>Even with the encouraging results shown in the proof of concept, some open questions can only be answered as part of the project:</p>
<ol style="list-style-type: decimal">
<li>Roundtrips from R to native code and then back to R currently are not recorded correctly by the native profiler. Additional investigation is necessary, it may be necessary to use specific compiler switches or even a specific compiler, or to patch the profiler library. In the worst case the profiler will assign all time spent in the native code to the R code that contains the native call.</li>
<li>It is unclear if <code>gperftools</code> or other sampling profilers can be used successfully on non-Linux operating systems, in particular on Windows. Reasonable efforts will be made to establish cross-platform compatibility, however in the worst case support for particular platforms may be restricted, and users will be instructed to use virtualization solutions.</li>
<li>Some modes of operation, such as profiling of ad-hoc native functions created by <code><a href="https://www.rdocumentation.org/packages/Rcpp/topics/cppFunction">Rcpp::cppFunction()</a></code>, may not be fully supported.</li>
<li>Integrated memory profiling is a desirable extra, but may not be achievable as part of the project.</li>
</ol>
<p>I expect to finish the “Improving DBI” project, funded by the ISC, by end of April. This project, if awarded, can then start right after that. I have submitted another proposal to the ISC, “Establishing DBI”. Should both projects be accepted, I still expect to adhere to the estimated completion times.</p>
</div>
</div>
<div id="how-can-the-isc-help" class="section level1">
<h1 class="hasAnchor">
<a href="#how-can-the-isc-help" class="anchor"></a>How can the ISC help?</h1>
<p>I would like to ask for financial support for the implementation of the project and for attending one conference to present the results. Only open-source libraries will be considered, licensing fees are not an issue.</p>
<p>Based on the timeline and the feature description, I would like to ask for USD 10’000 to cover the implementation costs. I will provide the equipment, backup funds are available to cover potential costs for replacement/repair. It would be great to present the work at useR!2017, I would also like to ask for reimbursement of the conference fee, accommodation, and transportation (approx. USD 1’000).</p>
</div>
<div id="dissemination" class="section level1">
<h1 class="hasAnchor">
<a href="#dissemination" class="anchor"></a>Dissemination</h1>
<p>The work will be continuously uploaded to GitHub, tested on r-hub, Travis-CI, and AppVeyor, and released to CRAN at the end of the project. GitHub seems to be very popular in the R community, its pull request mechanism allows contribution and code review in a very simple and convenient way. Maintainers of related packages (<code>profvis</code>, <code>aprof</code>, <code>proftools</code>, <code>GUIProfiler</code>, …) will be contacted and involved in a very early stage of the project. Design questions will be discussed on GitHub.</p>
<p>The newly implemented packages will be licensed under the MIT license to simplify their use for commercial purposes, except where linked or imported code requires a different licensing model.</p>
</div>
<div id="acknowledgments" class="section level1">
<h1 class="hasAnchor">
<a href="#acknowledgments" class="anchor"></a>Acknowledgments</h1>
<p>I would like to thank Hadley Wickham, who suggested to investigate joint profiling of R and native code, and also to Romain François who both gave feedback on an earlier version of the proposal. Thanks also to Winston Chang for supporting the extraction of code from his <code>profvis</code> package.</p>
</div>
<div id="about-the-author" class="section level1">
<h1 class="hasAnchor">
<a href="#about-the-author" class="anchor"></a>About the author</h1>
<p>I have a background in computer science, with more than 20 years of programming experience (mostly C++). I am currently working as a freelance IT consultant, and as a scientific assistant at the IVT, ETH Zurich. I am about to complete the “Improving DBI” project, courteously awarded by the ISC. Furthermore, I am currently maintaining the <code>tibble</code> package and contributing to the <code>dplyr</code> and other <em>tidyverse</em> packages.</p>
<p>I have been using R for data processing and statistical modeling since 2012. During this time I contributed numerous patches to various R packages, co-maintained the <code>tikzDevice</code> and <code>ProjectTemplate</code> packages, and implemented a few of my own. My <em>r-appveyor</em> script helps automated testing of R packages on Windows.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>For example, with a performance regression in a development version of <code>RSQLite</code>, the R profiling results seemed inconclusive, because the extra run time was being spent during the evaluation of a promise. The C++ profiling results have indicated that time was spent evaluating R code, but of course not which particular R code. With unified profiling data, the problem would have been spotted much easier.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Technically, it works by calling <code><a href="https://www.rdocumentation.org/packages/utils/topics/Rprof">Rprof()</a></code>, which installs a <code>SIGPROF</code> signal handler, and then replacing this handler by one that captures the native stack trace (using the <code>gperftools</code> library) and then records the R stack trace (by invoking the handler originally installed by <code><a href="https://www.rdocumentation.org/packages/utils/topics/Rprof">Rprof()</a></code>).<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#the-problem">The problem</a><ul class="nav nav-pills nav-stacked">
<li><a href="#why-is-it-a-problem">Why is it a problem?</a></li>
      <li><a href="#who-does-it-affect">Who does it affect?</a></li>
      <li><a href="#what-will-solving-the-problem-enable">What will solving the problem enable?</a></li>
      </ul>
</li>
      <li>
<a href="#the-plan">The plan</a><ul class="nav nav-pills nav-stacked">
<li><a href="#timeline">Timeline</a></li>
      <li><a href="#potential-pitfalls">Potential pitfalls</a></li>
      </ul>
</li>
      <li><a href="#how-can-the-isc-help">How can the ISC help?</a></li>
      <li><a href="#dissemination">Dissemination</a></li>
      <li><a href="#acknowledgments">Acknowledgments</a></li>
      <li><a href="#about-the-author">About the author</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kirill Müller, <a href="https://www.r-consortium.org">R Consortium</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
